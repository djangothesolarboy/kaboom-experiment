<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kabooooom</title>
</head>
<body>
    <script src="https://kaboomjs.com/lib/0.5.1/kaboom.js"></script>
    <script type="module">
        // initialize kaboom context
        const k = kaboom();

        //                  SPRITES
        //          name sprite     sprite location
        // k.loadSprite('skele', './assets/imgs/sprites/skele/Faceset.png');
        // k.loadSprite('skele-idle', './assets/imgs/sprites/skele/Idle.png');

        // k.loadSprite('skele-walk-left', './assets/imgs/sprites/skele/skele-walk-left.png', {
        //     sliceX: 1,
        //     sliceY: 4,
        //     anims: {
        //         left: {
        //             from: 0,
        //             to: 3
        //         }
        //     }
        // });

        k.loadSprite('skele', './assets/imgs/sprites/skele/skele.png', {
            sliceX: 4,
            sliceY: 6,
            gridWidth: 4,
            gridHeight: 6,
            anims: {
                down: {
                    from: 0,
                    to: 3
                },
                up: {
                    from: 4,
                    to: 7
                },
                // right: {
                //     from: 8,
                //     to: 11
                // },
                move: {
                    from: 12,
                    to: 15
                },
                idle: {
                    from: 16,
                    to: 19
                },
                jump: {
                    from: 20,
                    to: 23
                }
            }
        });

        //                  BACKGROUND SPRITES
        k.loadSprite('top-left', './assets/imgs/backgrounds/top-left.png');
        k.loadSprite('top-mid', './assets/imgs/backgrounds/top-mid.png');
        k.loadSprite('top-right', './assets/imgs/backgrounds/top-right.png');
        k.loadSprite('mid-right', './assets/imgs/backgrounds/mid-right.png');
        k.loadSprite('mid-left', './assets/imgs/backgrounds/mid-left.png');
        k.loadSprite('mid-mid', './assets/imgs/backgrounds/mid-mid.png');
        k.loadSprite('bot-left', './assets/imgs/backgrounds/bot-left.png');
        k.loadSprite('bot-mid', './assets/imgs/backgrounds/bot-mid.png');
        k.loadSprite('bot-right', './assets/imgs/backgrounds/bot-right.png');

        //                  SOUNDS
        k.loadSound('blip', './assets/sounds/blip.wav');
        k.loadSound('hurt', './assets/sounds/hurt.wav');

        // creates the order of the layers
        k.layers([
            'bg',
            'obj',
            'ui',
        ], 'obj'); // defaults as obj

        // define a scene
        k.scene("main", () => {

            // add a text at position
            k.add([
                k.text("menu", 32),
                k.pos(100, 100),
                k.layer('ui'),
            ]);

            // on key press, switches scenes
            k.keyPress('space', () => {
                k.play('blip', {
                    volume: 5.0
                });
                k.go('game');
            });
            
        });
        
        k.scene('game', () => {
            k.add([
                k.text('game', 32),
                k.pos(100, 100),
                k.layer('ui'),
            ]);

            const player = k.add([
                k.sprite('skele'),
                k.pos(100, 100),
                k.scale(1),
                k.origin('center'),
                k.body(),
                'player',
                'killable',
                { speed: 160 },
            ]);

            const map =k.addLevel([
                '=--------------------------------------]',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '(                                      )',
                '^                                      )',
                '=^^^^----------------------------------]',
            ], {
                width: 16,
                height: 16,
                pos: k.vec2(0, 0),
                '=': [
                    k.sprite('top-left'),
                    k.solid()
                ],
                '-': [
                    k.sprite('top-mid'),
                    k.solid()
                ],
                ']': [
                    k.sprite('top-right'),
                    k.solid()
                ],
                '(': [
                    k.sprite('mid-left'),
                    k.solid()
                ],
                ')': [
                    k.sprite('mid-right'),
                    k.solid()
                ],
                '^': [
                    k.sprite('top-left'),
                    k.solid(),
                    'hurt'
                ]
            });

            player.collides('hurt', () => {
                k.play('hurt', {
                    volume: 5.0
                });
            });

            // player.play('idle');

            k.keyPress('space', () => {
                k.play('blip', {
                    volume: 5.0
                });
                k.go('main');
            });
            
            // k.keyDown('left', () => {
            //     if (player.grounded() && player.curAnim() !== 'right') {
            //         player.play('left');
            //     }
            // });
            
            // k.keyDown('right', () => {
            //     if (player.grounded() && player.curAnim() !== 'left') {
            //         player.play('right');
            //     }
            // });

            k.keyDown(['left', 'right'], () => {
                if (player.grounded() && player.curAnim() !== 'move') {
                    player.play('move');
                } 
            });

            k.keyRelease(['left', 'right'], () => {
                if (!k.keyIsDown('right') && !k.keyIsDown('left')) {
                    player.play('idle');
                }
            });
            
            k.keyDown('left', () => {
                // player.play('move');
                player.flipX(1);
                player.move(-player.speed, 0);
            });
            
            k.keyDown('right', () => {
                // player.play('move');
                player.flipX(-1);
                player.move(player.speed, 0);
            });
        })

        // start the game
        k.start("main");

    </script>
</body>
</html>